<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Solvers - Laplacians.jl</title>
  

  <link rel="shortcut icon" href="../img/favicon.ico">

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  <link href="../Laplacians.css" rel="stylesheet">

  
  <script>
    // Current page data
    var mkdocs_page_name = "Solvers";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script>
  <script src="../js/theme.js"></script> 
  <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
  <script src="../mathjaxhelper.js"></script>

  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../about/index.html" class="icon icon-home"> Laplacians.jl</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../about/index.html">About</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>User Guide</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Julia/index.html">Using Julia</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../Laplacians/index.html">Overview</a>
        
    </li>

        
            
    <li class="toctree-l1 current">
        <a class="current" href="index.html">Solvers</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#solving-linear-equations-in-laplacians">Solving linear equations in Laplacians</a></li>
                
                    <li><a class="toctree-l4" href="#direct-solvers">Direct Solvers</a></li>
                
                    <li><a class="toctree-l4" href="#iterative-solvers">Iterative Solvers</a></li>
                
                    <li><a class="toctree-l4" href="#low-stretch-spanning-trees">Low-Stretch Spanning Trees</a></li>
                
                    <li><a class="toctree-l4" href="#augmented-spanning-tree-preconditioners">Augmented spanning tree preconditioners</a></li>
                
            
            </ul>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>API</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../generators/index.html">Generators</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../operations/index.html">Operations</a>
        
    </li>

        
    </ul>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../about/index.html">Laplacians.jl</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../about/index.html">Docs</a> &raquo;</li>
    
      
        
          <li>User Guide &raquo;</li>
        
      
    
    <li>Solvers</li>
    <li class="wy-breadcrumbs-aside">
      
        
          <a href="https://github.com/danspielman/Laplacians.jl" class="icon icon-github"> Edit on GitHub</a>
        
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <div class="toc">
<ul>
<li><a href="#solving-linear-equations-in-laplacians">Solving linear equations in Laplacians</a><ul>
<li><a href="#direct-solvers">Direct Solvers</a></li>
<li><a href="#iterative-solvers">Iterative Solvers</a></li>
<li><a href="#low-stretch-spanning-trees">Low-Stretch Spanning Trees</a></li>
<li><a href="#augmented-spanning-tree-preconditioners">Augmented spanning tree preconditioners</a></li>
</ul>
</li>
</ul>
</div>
<h1 id="solving-linear-equations-in-laplacians">Solving linear equations in Laplacians</h1>
<p>Right now, our solver code is in <code>solvers.jl</code>, but not included in yinsGraph.  So, you should include this directly.  Implementations of cg and pcg have been automatically included in yinsGraph.  They are in the file <code>pcg.jl</code></p>
<p>For some experiments with solvers, including some of those below, look at the notebook <a href="../Solvers.ipynb">Solvers.ipynb</a>.</p>
<h2 id="direct-solvers">Direct Solvers</h2>
<p>You can compute a cholesky factor directly with <code>cholfact</code>.  It does  more than just compute the factor, and it saves its result in a data structure that implements <code>\</code>.  It uses SuiteSparse by Tim Davis.</p>
<p>Here is an example of how you would use it to solve a general non-singular linear system.</p>
<pre><code class="julia">a = grid2(5)
la = lap(a)
la[1,1] = la[1,1] + 1
F = cholfact(la)

n = size(a)[1]
b = randn(n)
x = F \ b
norm(la*x-b)

    1.0598778281116327e-14
</code></pre>

<p>Laplacians, however, are singular.  So, we need to wrap the solver inside a routine that compensates for this.</p>
<pre><code class="julia">la = lap(a)
f = lapWrapSolver(cholfact,la)
b = randn(n); b = b - mean(b);
norm(la*f(b) - b)
    2.0971536951312585e-15
</code></pre>

<p>Here are two other ways of using the wrapper:</p>
<pre><code class="julia">lapChol = lapWrapSolver(cholfact)
f = lapChol(la)
b = randn(n); 
b = b - mean(b);
norm(la*f(b) - b)
    2.6924696662484416e-15

x = lapWrapSolver(cholfact,la,b)
norm(la*x - b)
    2.6924696662484416e-15
</code></pre>

<h2 id="iterative-solvers">Iterative Solvers</h2>
<p>The first, of course, is the Conjugate Gradient (cg).</p>
<p>Our implementation requires 2 arguments: the matrix and the right-hand vector.  It's optional arguments are the tolerance <code>tol</code> and the maximum number of iterations, <code>maxits</code>.  It has been written to use BLAS when possible, and slower routines when dealing with data types that BLAS cannot handle.  Here are examples.</p>
<pre><code class="julia">n = 50
a = randn(n,n); a = a * a';
b = randn(n)
x = cg(a,b,maxits=100)
norm(a*x - b)
    1.2191649497921835e-6

bbig = convert(Array{BigFloat,1},b)
xbig = cg(a,bbig,maxits=100)
norm(a*xbig - bbig)
    1.494919244242202629856363570306545126541716514824419323325986374186529786019681e-33
</code></pre>

<p>As a sanity check, we do two speed tests against Matlab.</p>
<pre><code class="julia">la = lap(grid2(200))
n = size(la)[1]
b = randn(n)
b = b - mean(b);
@time x = cg(la,b,maxits=1000)
    0.813791 seconds (2.77 k allocations: 211.550 MB, 3.56% gc time)

norm(la*x-b)
    0.0001900620047823064
</code></pre>

<p>And, in Matlab:</p>
<pre><code class="matlab">&gt;&gt; a = grid2(200);
&gt;&gt; la = lap(a);
&gt;&gt; b = randn(length(a),1); b = b - mean(b);
&gt;&gt; tic; x = pcg(la,b,[],1000); toc
pcg converged at iteration 688 to a solution with relative residual 9.8e-07.
Elapsed time is 1.244917 seconds.
&gt;&gt; norm(la*x-b)

ans =

   1.9730e-04
</code></pre>

<p>PCG also takes as input a preconditioner.  This should be a function.  Here is an example of how one might construct and use a diagonal preonditioner.  To motivate this, I will use a grid with highly varying weights on edges.</p>
<pre><code class="julia">a = mapweight(grid2(200),x-&gt;1/(rand(1)[1]));
la = lap(a)
n = size(la)[1]
b = randn(n)
b = b - mean(b);

d = diag(la)
pre(x) = x ./ d
@time x = pcg(la,b,pre,maxits=2000)
    3.322035 seconds (42.21 k allocations: 1.194 GB, 5.11% gc time)
norm(la*x-b)
    0.008508746034886803
</code></pre>

<p>If our target is just low error, and we are willing to allow many iterations, here's how cg and pcg compare on this example.</p>
<pre><code class="julia">@time x = pcg(la,b,pre,tol=1e-1,maxits=10^5)
    0.747042 seconds (9.65 k allocations: 275.819 MB, 4.87% gc time)
norm(la*x-b)
    19.840756251253442

@time x = cg(la,b,tol=1e-1,maxits=10^5)
    6.509665 seconds (22.55 k allocations: 1.680 GB, 3.68% gc time)
norm(la*x-b)
    19.222483530605043
</code></pre>

<h2 id="low-stretch-spanning-trees">Low-Stretch Spanning Trees</h2>
<p>In order to make preconditioners, we will want low-stretch spanning trees.  We do not yet have any code in Julia that is guaranteed to produce these.  Instead, for now, we have two routines that can be thought of as randomized versions of Prim and Kruskall's algorithm.
<code>randishKruskall</code> samples the remaining edges with probability proportional to their weight.  <code>randishPrim</code> samples edges on the boundary while using the same rule.</p>
<p>Both use a data structure called <code>Sampler</code> that allows you to store integers with real values, and to sample according to those real values.</p>
<p>We also have code for computing the stretches.
Here are some examples.</p>
<pre><code class="julia">a = grid2(1000)
t = randishKruskal(a);
st = compStretches(t,a);
sum(st)/nnz(a)
    43.410262262262265

t = randishPrim(a);
st = compStretches(t,a);
sum(st)/nnz(a)
    33.14477077077077

</code></pre>

<h2 id="augmented-spanning-tree-preconditioners">Augmented spanning tree preconditioners</h2>
<p>Here is code that will invoke one.<br />
It is designed for positive definite systems.  So, let's give it one.
Right now, it is using a randomized version of a MST.  There is no real reason to think that this should work.</p>
<pre><code class="julia">a = mapweight(grid2(1000),x-&gt;1/(rand(1)[1]));
la = lap(a)
n = size(la)[1]
la[1,1] = la[1,1] + 1
@time F = augTreeSolver(la,tol=1e-1,maxits=1000)
    6.529052 seconds (4.00 M allocations: 1.858 GB, 15.34% gc time)

b = randn(n)
@time x = F(b)
    29.058915 seconds (9.74 k allocations: 23.209 GB, 6.84% gc time)

norm(la*x - b)
    99.74452367765869

# Now, let's contrast with using CG

@time y = cg(la,b,tol=1e-1,maxits=1000)
    28.719631 seconds (4.01 k allocations: 7.473 GB, 3.74% gc time)

norm(la*y-b)
    3243.6014713600766

</code></pre>

<p>That was not too impressive.  We will have to investigate.  By default, it presently uses randishKruskal.  Let's try randishPrim.  You can pass the treeAlg as a parameter.</p>
<pre><code class="julia">@time F = augTreeSolver(la,tol=1e-1,maxits=1000,treeAlg=randishPrim);
    6.319489 seconds (4.00 M allocations: 2.030 GB, 18.81% gc time)

b = randn(n)
@time x = F(b)
    29.503484 seconds (9.76 k allocations: 23.268 GB, 7.31% gc time)

norm(la*x - b)  
    99.29610874176991
</code></pre>

<p>To solve systems in a Laplacian, we could wrap it.</p>
<pre><code class="julia">n = 40000
la = lap(randRegular(n,3))
f = lapWrapSolver(augTreeSolver,la,tol=1e-6,maxits=1000)
b = randn(n); b = b - mean(b)
x = f(b)
norm(la*x-b)
    0.00019304778073388
</code></pre>

<p>As you can see, lapWrapSolver can pass tol and maxits arguments to its solver, if they are given to it.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../generators/index.html" class="btn btn-neutral float-right" title="Generators"/>Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../Laplacians/index.html" class="btn btn-neutral" title="Overview"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a class="icon icon-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../Laplacians/index.html" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../generators/index.html" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>

</body>
</html>
